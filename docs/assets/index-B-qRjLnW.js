var C=Object.defineProperty;var R=(r,e,t)=>e in r?C(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var c=(r,e,t)=>(R(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const a={column:10,row:20,FPS:165,speed:2,keySpeed:10,score:0,get brickWidth(){return window.innerWidth/this.column},get brickHeight(){return window.innerHeight/this.row}},b={o:{color:"#FADADD",struct:["11","11"]},i:{color:"#F7E9D4",struct:["0000","1111","0000","0000"]},s:{color:"#C8E6C9",struct:["011","110","000"]},z:{color:"#B3E5FC",struct:["110","011","000"]},l:{color:"#FFCC80",struct:["001","111","000"]},j:{color:"#FFEE58",struct:["100","111","000"]},t:{color:"#CE93D8",struct:["000","111","010"]}},m={operate:{left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["w","ArrowUp"],down:["s","ArrowDown"],bottom:[" "]},onceKey:["up","bottom"],speedUpKey:["down"],pause:"Enter"},T=(r,{x:e,y:t,width:n,height:i,color:o})=>{var s=8,l=5;r.fillStyle=o,r.beginPath(),r.moveTo(e+s,t),r.lineTo(e+n-s,t),r.arcTo(e+n,t,e+n,t+s,s),r.lineTo(e+n,t+i-s),r.arcTo(e+n,t+i,e+n-s,t+i,s),r.lineTo(e+s,t+i),r.arcTo(e,t+i,e,t+i-s,s),r.lineTo(e,t+s),r.arcTo(e,t,e+s,t,s),r.fill(),r.strokeStyle="#000000",r.lineWidth=l,r.beginPath(),r.moveTo(e+s,t),r.lineTo(e+n-s,t),r.arcTo(e+n,t,e+n,t+s,s),r.lineTo(e+n,t+i-s),r.arcTo(e+n,t+i,e+n-s,t+i,s),r.lineTo(e+s,t+i),r.arcTo(e,t+i,e,t+i-s,s),r.lineTo(e,t+s),r.arcTo(e,t,e+s,t,s),r.stroke(),r.closePath()},F=(r,{x:e,y:t,width:n,height:i,color:o,structure:s})=>{for(let l=0;l<s.length;l++)for(let u=0;u<s[l].length;u++)s[l][u]!="0"&&T(r,{x:(e+u)*n,y:(t+l)*i,width:n,height:i,color:o})},P=function(r,e,t=a.brickWidth,n=a.brickHeight){r.clearRect(0,0,r.canvas.width,r.canvas.height);for(let i=0;i<e.length;i++)for(let o=0;o<e[i].length;o++)e[i][o]!==void 0&&T(r,{x:o*t,y:i*n,width:t,height:n,color:e[i][o]})},j=()=>{const r=Object.keys(b);return r[Math.random()*r.length>>0]},E=r=>{const e=r.findLastIndex(t=>+t!=0);return e===-1?-r.length:-e-1};class v{constructor(e=performance.now()){c(this,"letter");c(this,"color");c(this,"structure");c(this,"x");c(this,"y");c(this,"lastTime");c(this,"isRecycle",!1);c(this,"width",a.brickWidth);c(this,"height",a.brickHeight);this.letter=j(),this.color=b[this.letter].color,this.structure=b[this.letter].struct,this.x=a.column/2-1,this.y=E(this.structure),this.lastTime=e}draw(e){F(e,this)}update(e,t){return e-this.lastTime>=1e3/a.speed?(this.lastTime=e-(e-this.lastTime)%(1e3/a.speed),this.isOverlap(t,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)):!1}left(e){this.inBorder("left")||this.isOverlap(e,this.getBinary(),this.x-1)||this.x--}right(e){this.inBorder("right")||this.isOverlap(e,this.getBinary(),this.x+1)||this.x++}downOne(e){return this.isOverlap(e,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)}downBottom(e){for(;!this.isOverlap(e,this.getBinary(),this.x,this.y+1);)this.y++;return!0}rotate(e){const t=this.structure[0].length;let n=Array.from({length:t},()=>new Array(t));for(let o=0;o<this.structure.length;o++)for(let s=0;s<this.structure[o].length;s++){let l=o,u=t-1-s;if(this.structure[o][s]==="1"&&(l+this.x>=a.column||l+this.x<0||u+this.y>=a.row))return;n[u][l]=this.structure[o][s]}n=n.map(o=>o.join(""));const i=this.getBinary(n);this.isOverlap(e,i)||(this.structure=n)}getBinary(e=this.structure,t=this.x){const n=[],i=e[0].length;for(let o=e.length-1;o>=0;o--){let s,l=a.column-t-i;l>=0?s=parseInt(e[o],2)<<l:s=parseInt(e[o],2)>>-l,n.unshift(s)}return n}isOverlap(e,t=this.getBinary(),n=this.x,i=this.y){if(n-this.x!==0){const o=n-this.x;o>0?t=t.map(s=>s>>o):t=t.map(s=>s<<-o)}for(let o=t.length-1;o>=0;o--)if(!(i+o<0)&&t[o]&(e[i+o]??2**a.column-1))return!0;return!1}inBorder(e){let t=this.getBinary(),n=e=="left"?2**(a.column-1):1;for(let i=t.length-1;i>=0;i--)if(t[i]&n)return!0;return!1}}const w={left:!1,right:!1,up:!1,down:!1,bottom:!1};let g=null;window.onkeydown=r=>{switch(r.key){default:for(const e of Object.keys(m.operate))m.operate[e].some(t=>t===r.key)&&(g=r.key)}};window.onkeyup=r=>{switch(r.key){case g:g=null;default:let e;(e=A(r.key))&&(w[e]=!1)}};const A=r=>{for(const[e,t]of Object.entries(m.operate))if(t.some(n=>n===r))return e},L=r=>{let e=1e3/a.keySpeed;return m.speedUpKey.some(t=>t===r)&&(e=500/a.keySpeed),e},k=function(){const r={left:"left",right:"right",down:"downOne",bottom:"downBottom",up:"rotate"};return(e,t)=>m.onceKey.some(n=>n===t)&&w[t]?null:e[r[t]].bind(e)}();let p=0;const S=function(r){if(g===null)return;let e=Date.now();const t=A(g);if(!w[t]){p=e;let i=k(r,t);i==null||i(),w[t]=!0;return}let n=L(t);if(e-p>=n){p=e-(e-p)%n;let i=k(r,t);i&&i()}},D=(r,e,t)=>{if(I(r,t))return alert("Game Over"),!1;const n=t.getBinary();for(let i=n.length-1;i>=0;i--)if(n[i]!==0){r[t.y+i]|=n[i];for(let o=a.column-1,s=n[i];s!==0;o--,s>>=1)s&1&&(e[t.y+i][o]=t.color)}return!0},K=(r,e)=>{let t=0;for(let n=a.row-1;n>=0;n--)r[n]===2**a.column-1&&(t++,r.splice(n,1),r.unshift(0),e.splice(n,1),e.unshift(Array.from({length:a.column})),n++);return t},I=(r,e)=>{const t=e.structure.length;for(let n=0;n<t;n++)if(e.y+n<0)return!0;return!1},N=r=>document.querySelector(r),W=(r,e)=>{if(e&&(!Number.isInteger(e)||e<=0))throw new TypeError("fps 应该是一个正整数");let t;function n(){const o=(()=>{if(e){const l=1e3/e;let u=0;return y=>{const B=y-u;B>=l&&(r(y),u=y-B%l)}}return l=>{r(l)}})(),s=l=>{t=requestAnimationFrame(s),o(l)};i(),s(0)}function i(){cancelAnimationFrame(t)}return[n,i]},h=N(".canvas.brick"),d=N(".canvas.bg");h.height=d.height=window.innerHeight;h.width=d.width=window.innerWidth;class H{constructor(e,t){this.mapBinary=e,this.brick=t}left(){this.brick.left(this.mapBinary)}right(){this.brick.right(this.mapBinary)}downOne(){this.brick.downOne(this.mapBinary)&&(this.brick.isRecycle=!0)}downBottom(){this.brick.downBottom(this.mapBinary)&&(this.brick.isRecycle=!0)}rotate(){this.brick.rotate(this.mapBinary)}}class O{constructor(){c(this,"gameOver",!1);c(this,"mapBinary",new Array(a.row).fill(0));c(this,"bg",Array.from({length:a.row},()=>Array.from({length:a.column})));c(this,"operate",new H(this.mapBinary,new v));c(this,"ctx",h.getContext("2d"));c(this,"bgCtx",d.getContext("2d"));c(this,"raf",W(e=>{this.ctx.clearRect(0,0,h.width,h.height),this.draw(),this.update(e),this.userAction(this.operate),this.canNextOne(e)},100));c(this,"start",this.raf[0]);c(this,"cancel",this.raf[1]);c(this,"userAction",S)}draw(){this.operate.brick.draw(this.ctx)}update(e){this.operate.brick.update(e,this.mapBinary)&&(this.operate.brick.isRecycle=!0)}canNextOne(e){this.operate.brick.isRecycle&&this.newNextOne(e)}newNextOne(e){if(this.gameOver=!D(this.mapBinary,this.bg,this.operate.brick),this.gameOver){this.reStartGame();return}K(this.mapBinary,this.bg),P(this.bgCtx,this.bg),this.operate.brick=new v(e)}reStartGame(){this.cancel(),f.ctx.clearRect(0,0,h.width,h.height),f.bgCtx.clearRect(0,0,d.width,d.height),f=new O,f.start()}}let f=new O;f.start();
