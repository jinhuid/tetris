var H=Object.defineProperty;var L=(s,e,t)=>e in s?H(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var o=(s,e,t)=>(L(s,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();const m=s=>document.querySelector(s),_=(s,e)=>{if(e&&(!Number.isInteger(e)||e<=0))throw new TypeError("fps 应该是一个正整数");let t;function i(...n){const a=(()=>{if(e){const h=1e3/e;let u=0;return d=>{const p=d-u;p>=h&&(s.apply(this,[d,...n]),u=d-p%h)}}return h=>{s.apply(this,[h,...n])}})(),l=h=>{t=requestAnimationFrame(l),a(h)};r(),l(0)}function r(){cancelAnimationFrame(t)}return[i,r]};function T(s){let e;const t=new Proxy(s,{construct(i,r){return e||(e=Reflect.construct(i,r)),e}});return s.prototype.constructor=t,t}const F=m(".game"),{width:I,height:j}=F.getBoundingClientRect(),c={column:10,row:20,FPS:null,speed:2,keySpeed:10,score:0,devicePixelRatio:window.devicePixelRatio,get brickWidth(){return Math.round(I*this.devicePixelRatio/this.column)},get brickHeight(){return Math.round(j*this.devicePixelRatio/this.row)},get windowWidth(){return this.brickWidth*this.column},get windowHeight(){return this.brickHeight*this.row}},D=(s,{x:e,y:t,width:i,height:r,color:n})=>{const a=r/10*c.devicePixelRatio,l=r/25*c.devicePixelRatio;s.fillStyle=n,s.beginPath(),s.moveTo(e+a,t),s.lineTo(e+i-a,t),s.arcTo(e+i,t,e+i,t+a,a),s.lineTo(e+i,t+r-a),s.arcTo(e+i,t+r,e+i-a,t+r,a),s.lineTo(e+a,t+r),s.arcTo(e,t+r,e,t+r-a,a),s.lineTo(e,t+a),s.arcTo(e,t,e+a,t,a),s.fill();const h=e+l/2,u=t+l/2,d=i-l,p=r-l;s.strokeStyle="#000000",s.lineWidth=l,s.beginPath(),s.moveTo(h+a,u),s.lineTo(h+d-a,u),s.arcTo(h+d,u,h+d,u+a,a),s.lineTo(h+d,u+p-a),s.arcTo(h+d,u+p,h+d-a,u+p,a),s.lineTo(h+a,u+p),s.arcTo(h,u+p,h,u+p-a,a),s.lineTo(h,u+a),s.arcTo(h,u,h+a,u,a),s.stroke(),s.closePath()},y=document.createElement("canvas"),K=y.getContext("2d");y.height=c.brickHeight*20;y.width=c.brickWidth;let G=0;const w={},A=(s,{x:e,y:t,width:i,height:r,color:n})=>{if(n in w){s.drawImage(y,0,r*w[n],i,r,e,t,i,r);return}D(K,{x:0,y:G*r,width:i,height:r,color:n}),w[n]=G++,s.drawImage(y,0,r*w[n],i,r,e,t,i,r)},M=(s,{x:e,y:t,width:i,height:r,color:n,structure:a})=>{for(let l=0;l<a.length;l++)for(let h=0;h<a[l].length;h++)a[l][h]!="0"&&A(s,{x:(e+h)*i,y:(t+l)*r,width:i,height:r,color:n})},U=function(s,e,t=c.brickWidth,i=c.brickHeight){s.clearRect(0,0,s.canvas.width,s.canvas.height);for(let r=0;r<e.length;r++)for(let n=0;n<e[r].length;n++)e[r][n]!==void 0&&A(s,{x:n*t,y:r*i,width:t,height:i,color:e[r][n]})},E=m(".canvas.brick"),W=m(".canvas.bg");E.height=W.height=c.windowHeight;E.width=W.width=c.windowWidth;const v=class v{constructor(){o(this,"ctx");o(this,"bgCtx");o(this,"mapBinary");o(this,"bg");this.ctx=v.ctx,this.bgCtx=v.bgCtx,this.mapBinary=new Array(c.row).fill(0),this.bg=Array.from({length:c.row},()=>Array.from({length:c.column}))}cleanUpCanvas(){this.clearCanvas(this.ctx),this.clearCanvas(this.bgCtx)}clearCanvas(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)}};o(v,"ctx",E.getContext("2d")),o(v,"bgCtx",W.getContext("2d"));let k=v;const B={o:{color:"#FADADD",struct:["11","11"]},i:{color:"#F7E9D4",struct:["0000","1111","0000","0000"]},s:{color:"#C8E6C9",struct:["011","110","000"]},z:{color:"#B3E5FC",struct:["110","011","000"]},l:{color:"#FFCC80",struct:["001","111","000"]},j:{color:"#FFEE58",struct:["100","111","000"]},t:{color:"#CE93D8",struct:["000","111","010"]},".":{color:"green",struct:["1"]}},q=s=>{const e=s.findLastIndex(t=>+t!=0);return e===-1?-s.length:-e-1};class x{constructor(e,t=performance.now()){o(this,"color");o(this,"width");o(this,"height");o(this,"structure");o(this,"x");o(this,"y");o(this,"isRecycle",!1);this.letter=e,this.lastTime=t,this.color=B[this.letter].color,this.width=c.brickWidth,this.height=c.brickHeight,this.structure=B[this.letter].struct,this.x=c.column/2-1,this.y=q(this.structure)}draw(e){M(e,this)}update(e,t){return e-this.lastTime>=1e3/c.speed?(this.lastTime=e-(e-this.lastTime)%(1e3/c.speed),this.isOverlap(t,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)):!1}left(e){this.isAtBorder("left")||this.isOverlap(e,this.getBinary(),this.x-1)||this.x--}right(e){this.isAtBorder("right")||this.isOverlap(e,this.getBinary(),this.x+1)||this.x++}downOne(e){return this.isOverlap(e,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)}downBottom(e){for(;!this.isOverlap(e,this.getBinary(),this.x,this.y+1);)this.y++;return!0}rotate(e){const t=this.structure[0].length;let i=Array.from({length:t},()=>new Array(t));for(let n=0;n<this.structure.length;n++)for(let a=0;a<this.structure[n].length;a++){let l=n,h=t-1-a;if(this.structure[n][a]==="1"&&(l+this.x>=c.column||l+this.x<0||h+this.y>=c.row))return;i[h][l]=this.structure[n][a]}i=i.map(n=>n.join(""));const r=this.getBinary(i);this.isOverlap(e,r)||(this.structure=i)}getBinary(e=this.structure,t=this.x){const i=[],r=e[0].length,n=c.column-t-r;for(let a=r-1;a>=0;a--){let l;n>=0?l=parseInt(e[a],2)<<n:l=parseInt(e[a],2)>>-n,i.unshift(l)}return i}correctLastTime(e){this.lastTime=e}isOverlap(e,t=this.getBinary(),i=this.x,r=this.y){if(i-this.x!==0){const n=i-this.x;n>0?t=t.map(a=>a>>n):t=t.map(a=>a<<-n)}for(let n=t.length-1;n>=0;n--)if(!(r+n<0)&&t[n]&(e[r+n]??2**c.column-1))return!0;return!1}isAtBorder(e){const t=this.getBinary(),i={left:2**(c.column-1),right:1};for(let r=t.length-1;r>=0;r--)if(t[r]&i[e])return!0;return!1}}class Y{getRandomLetter(){const e=Object.keys(B);return e[Math.random()*e.length>>0]}record(e,t,i){if(this.isGameOver(i))return!1;const r=i.getBinary();for(let n=r.length-1;n>=0;n--)if(r[n]!==0){e[i.y+n]|=r[n];for(let a=c.column-1,l=r[n];l!==0;a--,l>>=1)l&1&&(t[i.y+n][a]=i.color)}return!0}eliminate(e,t){let i=0;for(let r=c.row-1;r>=0;r--)e[r]===2**c.column-1&&(i++,e.splice(r,1),e.unshift(0),t.splice(r,1),t.unshift(Array.from({length:c.column})),r++);return i}isGameOver(e){const t=e.structure.length;for(let i=0;i<t;i++)if(e.y+i<0)return!0;return!1}computeScore(e){switch(e){case 0:return 20;case 1:return 120;case 2:return 320;case 3:return 720;case 4:return 1520;default:return 20}}}const z=T(Y),V=new z,g={operate:{left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["w","ArrowUp"],down:["s","ArrowDown"],bottom:[" "]},onceKey:["up","bottom"],speedUpKey:["down"],speedUpRate:2,pause:["Enter","p"]},C={left:!1,right:!1,up:!1,down:!1,bottom:!1};let f=null;window.onkeydown=s=>{switch(!0){case g.pause.some(e=>e===s.key):f=s.key;break;case Object.values(g.operate).flat(1).some(e=>e===s.key):f=s.key}};window.onkeyup=s=>{switch(!0){case f===s.key:f=null;default:let e;(e=N(s.key))&&(C[e]=!1)}};function N(s){if(g.pause.some(e=>e===s))return"pause";for(const[e,t]of Object.entries(g.operate))if(t.some(i=>i===s))return e}const X=s=>{let e=1e3/c.keySpeed;return g.speedUpKey.some(t=>t===s)&&(e=1e3/g.speedUpRate/c.keySpeed),e},P=function(){const s={left:"left",right:"right",down:"downOne",bottom:"downBottom",up:"rotate"};return(e,t)=>g.onceKey.some(i=>i===t)&&C[t]?null:e[s[t]].bind(e)}(),$=s=>g.pause.some(e=>e===s);let b=0;const J=function(s,e){if(f===null)return;if($(f)){e.pauseGame(),f=null;return}if(s)return;let t=Date.now();const i=N(f);if(!C[i]){b=t;let n=P(e,i);n==null||n(),C[i]=!0;return}let r=X(i);if(t-b>=r){b=t-(t-b)%r;let n=P(e,i);n==null||n()}};class Q{constructor(e,t,i,r){this.renderer=e,this.canvasWithMapCtx=t,this.brick=i,this.Player=r}takeTurns(e){this.brick=e}left(){this.brick.left(this.canvasWithMapCtx.mapBinary)}right(){this.brick.right(this.canvasWithMapCtx.mapBinary)}downOne(){this.brick.downOne(this.canvasWithMapCtx.mapBinary)&&(this.brick.isRecycle=!0)}downBottom(){this.brick.downBottom(this.canvasWithMapCtx.mapBinary)&&(this.brick.isRecycle=!0)}rotate(){this.brick.rotate(this.canvasWithMapCtx.mapBinary)}pauseGame(){this.renderer.pause?this.Player.playGame():this.Player.pauseGame()}}class Z{constructor(){o(this,"_score",0);o(this,"_eliminateNum",0)}get score(){return this._score}get eliminateNum(){return this._eliminateNum}scoreIncrease(e){this._score+=e}eliminateNumIncrease(e){this._eliminateNum+=e}reset(){this._score=0,this._eliminateNum=0}}const ee=T(Z),O=new ee;class te{constructor(){o(this,"events",{})}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}emit(e,...t){const i=this.events[e];i&&i.forEach(r=>{r(...t)})}off(e,t){const i=this.events[e];i&&(this.events[e]=i.filter(r=>r!==t))}clearAllListeners(){this.events={}}}const re=T(te),S=new re;class R{constructor(e){o(this,"canvasWithMapCtx");o(this,"operation");o(this,"scorer");o(this,"eventEmitter");o(this,"gameHelper");o(this,"brick");o(this,"nextBrick");o(this,"lastTime",0);o(this,"pauseTime",0);o(this,"_over",!1);o(this,"_pause",!1);this.canvasWithMapCtx=e,this.scorer=O,this.eventEmitter=S,this.gameHelper=V,this.brick=new x(this.gameHelper.getRandomLetter()),this.nextBrick=new x(this.gameHelper.getRandomLetter()),this.operation=new Q(this,this.canvasWithMapCtx,this.brick,{playGame:this.playGame.bind(this),pauseGame:this.pauseGame.bind(this)})}get over(){return this._over}get pause(){return this._pause}render(e){if(this.userActions(),this._pause){this.cachePauseTime(e);return}this.clearCanvas(this.canvasWithMapCtx.ctx),this.lastTime=e,this.draw(),this.update(e-this.pauseTime),this.canNextOne(e-this.pauseTime)}clearCanvas(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)}draw(){this.operation.brick.draw(this.canvasWithMapCtx.ctx)}update(e){this.operation.brick.update(e,this.canvasWithMapCtx.mapBinary)&&(this.operation.brick.isRecycle=!0)}canNextOne(e){this.operation.brick.isRecycle&&this.newNextOne(e)}newNextOne(e){if(!this.gameHelper.record(this.canvasWithMapCtx.mapBinary,this.canvasWithMapCtx.bg,this.brick)){this._over=!0;return}const i=this.gameHelper.eliminate(this.canvasWithMapCtx.mapBinary,this.canvasWithMapCtx.bg),r=this.gameHelper.computeScore(i);this.scorer.scoreIncrease(r),this.scorer.eliminateNumIncrease(i),this.eventEmitter.emit("updateScore",this.scorer.score),this.eventEmitter.emit("updateEliminate",this.scorer.eliminateNum),U(this.canvasWithMapCtx.bgCtx,this.canvasWithMapCtx.bg),this.brick=this.nextBrick,this.nextBrick=new x(this.gameHelper.getRandomLetter(),e),this.eventEmitter.emit("updateNextBrick",this.nextBrick),this.brick.correctLastTime(e),this.operation.takeTurns(this.brick)}cachePauseTime(e){this.pauseTime+=e-this.lastTime,this.lastTime=e}playGame(){this._pause=!1}pauseGame(){this._pause=!0}userActions(){J(this._pause,this.operation)}}class se{constructor(){o(this,"canvasWithMapCtx");o(this,"renderer");o(this,"Scorer");o(this,"startWithEnd");this.canvasWithMapCtx=new k,this.Scorer=O,this.renderer=new R(this.canvasWithMapCtx),this.startWithEnd=_((e=performance.now())=>{this.renderer.render(e)},c.FPS)}get score(){return this.Scorer.score}get over(){return this.renderer.over}get pause(){return this.renderer.pause}startGame(){this.startWithEnd[0]()}cancelGame(){this.startWithEnd[1]()}restartGame(){this.canvasWithMapCtx.cleanUpCanvas(),this.canvasWithMapCtx=new k,this.renderer=new R(this.canvasWithMapCtx)}playGame(){this.renderer.playGame()}pauseGame(){this.renderer.pauseGame()}}class ie{constructor(){o(this,"game");o(this,"dom");o(this,"eventEmitter");o(this,"scorer");this.game=new se,this.eventEmitter=S,this.scorer=O,this.dom={brickCanvas:m(".brick"),bgCanvas:m(".bg"),nextBrickCanvas:m(".next_brick"),start:m(".start"),pause:m(".pause"),regame:m(".regame"),restart:m(".restart"),score:m(".score>span"),eliminate:m(".eliminate>span")},this.dom.nextBrickCanvas.width=c.brickWidth*4,this.dom.nextBrickCanvas.height=c.brickHeight*4,this.init(),this.addEvent()}init(){this.eventEmitter.clearAllListeners(),this.eventEmitter.on("updateScore",()=>{this.dom.score.innerText=this.scorer.score+""}),this.eventEmitter.on("updateEliminate",()=>{this.dom.eliminate.innerText=this.scorer.eliminateNum+""}),this.eventEmitter.on("updateNextBrick",e=>{this.dom.nextBrickCanvas.getContext("2d").clearRect(0,0,this.dom.nextBrickCanvas.width,this.dom.nextBrickCanvas.height),M(this.dom.nextBrickCanvas.getContext("2d"),{...e,x:0,y:0})})}addEvent(){this.dom.start.addEventListener("click",()=>{this.game.startGame(),this.dom.start.style.display="none",this.dom.pause.style.display="block"}),this.dom.pause.addEventListener("click",()=>{this.game.pause?(this.game.playGame(),this.dom.pause.innerText="暂停"):(this.game.pauseGame(),this.dom.pause.innerText="继续")}),this.dom.regame.addEventListener("click",()=>{this.scorer.reset(),this.eventEmitter.emit("updateScore",this.scorer.score),this.game.restartGame(),this.init()})}}new ie;
