var N=Object.defineProperty;var S=(s,t,e)=>t in s?N(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var h=(s,t,e)=>(S(s,typeof t!="symbol"?t+"":t,e),e);import{gameParam as l}from"./gameConfig-DWGiOOs9.js";import G from"./CanvasWithMapCtx-DIQaPKYH.js";import{s as A}from"./index-D2CPmTWw.js";const E=(s,{x:t,y:e,width:i,height:a,color:n})=>{const r=a/10*l.devicePixelRatio,c=a/25*l.devicePixelRatio;s.fillStyle=n,s.beginPath(),s.moveTo(t+r,e),s.lineTo(t+i-r,e),s.arcTo(t+i,e,t+i,e+r,r),s.lineTo(t+i,e+a-r),s.arcTo(t+i,e+a,t+i-r,e+a,r),s.lineTo(t+r,e+a),s.arcTo(t,e+a,t,e+a-r,r),s.lineTo(t,e+r),s.arcTo(t,e,t+r,e,r),s.fill();const o=t+c/2,u=e+c/2,m=i-c,p=a-c;s.strokeStyle="#000000",s.lineWidth=c,s.beginPath(),s.moveTo(o+r,u),s.lineTo(o+m-r,u),s.arcTo(o+m,u,o+m,u+r,r),s.lineTo(o+m,u+p-r),s.arcTo(o+m,u+p,o+m-r,u+p,r),s.lineTo(o+r,u+p),s.arcTo(o,u+p,o,u+p-r,r),s.lineTo(o,u+r),s.arcTo(o,u,o+r,u,r),s.stroke(),s.closePath()},v=document.createElement("canvas"),H=v.getContext("2d");v.height=l.brickHeight*20;v.width=l.brickWidth;let b=0;const w={},R=(s,{x:t,y:e,width:i,height:a,color:n})=>{if(n in w){s.drawImage(v,0,a*w[n],i,a,t,e,i,a);return}E(H,{x:0,y:b*a,width:i,height:a,color:n}),w[n]=b++,s.drawImage(v,0,a*w[n],i,a,t,e,i,a)},W=(s,{x:t,y:e,width:i,height:a,color:n,structure:r})=>{let c=0,o=0;for(;c<r.length;)r[c]&1<<r.length-1-o&&R(s,{x:(t+o)*i,y:(e+c)*a,width:i,height:a,color:n}),o++,o===r.length&&(o=0,c++)},T={o:{color:"#FADADD",struct:["11","11"]},i:{color:"#F7E9D4",struct:["0000","1111","0000","0000"]},s:{color:"#C8E6C9",struct:["011","110","000"]},z:{color:"#B3E5FC",struct:["110","011","000"]},l:{color:"#FFCC80",struct:["001","111","000"]},j:{color:"#FFEE58",struct:["100","111","000"]},t:{color:"#CE93D8",struct:["000","111","010"]},".":{color:"green",struct:["1"]}},j=s=>{const t=s.findLastIndex(e=>e!==0);return t===-1?-s.length:-t-1},F=s=>s.map(t=>parseInt(t,2)),C=2**l.column-1,y=class y{constructor(t,e=performance.now()){h(this,"color");h(this,"width");h(this,"height");h(this,"structure");h(this,"x");h(this,"y");h(this,"isRecycle",!1);this.letter=t,this.lastTime=e,this.color=T[this.letter].color,this.width=y.width,this.height=y.height,this.structure=F(T[this.letter].struct),this.x=Math.floor(l.column/2)-Math.floor(this.structure.length/2),this.y=j(this.structure)}draw(t){W(t,this)}update(t,e){return t-this.lastTime>=1e3/l.speed?(this.lastTime=t-(t-this.lastTime)%(1e3/l.speed),this.isOverlap(e,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)):!1}left(t){this.isAtBorder("left")||this.isOverlap(t,this.getBinary(),this.x-1)||this.x--}right(t){this.isAtBorder("right")||this.isOverlap(t,this.getBinary(),this.x+1)||this.x++}downOne(t){return this.isOverlap(t,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)}downToBottom(t){for(;!this.isOverlap(t,this.getBinary(),this.x,this.y+1);)this.y++;return!0}rotate(t){const e=this.structure.length,i=new Array(e).fill(0);let a=0,n=0;for(;a<e;){if(this.structure[a]&1<<e-1-n){const r=a,c=e-1-n;if(r+this.x>=l.column||r+this.x<0||c+this.y>=l.row)return;i[c]+=1<<e-1-r}n++,n===e&&(a++,n=0)}this.isOverlap(t,this.getBinary(i))||(this.structure=i)}getBinary(t=this.structure,e=this.x){const i=l.column-e-t.length;return t.map(a=>i>=0?a<<i:a>>-i)}correctLastTime(t){this.lastTime=t}isOverlap(t,e=this.getBinary(),i=this.x,a=this.y){if(i-this.x!==0){const n=i-this.x;n>0?e=e.map(r=>r>>n):e=e.map(r=>r<<-n)}return e.some((n,r)=>{if(a+r<0)return!1;if(n&(t[a+r]??C))return!0})}isAtBorder(t){const e=this.getBinary(),i=t==="left"?(C+1)/2:1;return e.some(a=>a&i)}};h(y,"height",l.brickHeight),h(y,"width",l.brickWidth);let g=y;const D=(s,t)=>{if(t&&(!Number.isInteger(t)||t<=0))throw new TypeError("fps 应该是一个正整数");let e;function i(...n){const r=(()=>{if(t){const o=1e3/t;let u=0;return m=>{const p=m-u;p>=o&&(s.apply(this,[m,...n]),u=m-p%o)}}return o=>{s.apply(this,[o,...n])}})(),c=o=>{e=requestAnimationFrame(c),r(o)};a(),c(0)}function a(){cancelAnimationFrame(e)}return[i,a]};function P(s){let t;const e=new Proxy(s,{construct(i,a){return t||(t=Reflect.construct(i,a)),t}});return s.prototype.constructor=e,e}class L{constructor(){h(this,"eliminateTarget",2**l.column-1)}getRandomLetter(){const t=Object.keys(T);return t[Math.random()*t.length>>0]}record(t,e,i){if(this.isGameOver(i))return!1;const a=i.getBinary();for(let n=a.length-1;n>=0;n--)if(a[n]!==0){t[i.y+n]|=a[n];for(let r=l.column-1,c=a[n];c!==0;r--,c>>=1)c&1&&(e[i.y+n][r]=i.color)}return!0}eliminate(t,e,i,a){let n=0;for(;i<a;){if(t[i]===this.eliminateTarget){t.splice(i,1),t.unshift(0),e.splice(i,1),e.unshift(new Array(e[0].length)),n++;continue}i++}return n}isGameOver(t){const e=t.structure.length;for(let i=0;i<e;i++)if(t.y+i<0)return!0;return!1}drawBg(t,e,i,a){t.clearRect(0,0,t.canvas.width,t.canvas.height);for(let n=0;n<e.length;n++)for(let r=0;r<e[n].length;r++)e[n][r]!==void 0&&R(t,{x:r*i,y:n*a,width:i,height:a,color:e[n][r]})}drawNextBrick(t,e){t.clearRect(0,0,t.canvas.width,t.canvas.height),W(t,{...e,x:0,y:0})}computeScore(t){switch(t){case 0:return 20;case 1:return 120;case 2:return 320;case 3:return 720;case 4:return 1520;default:return 20}}}const K=P(L),M=new K,d={operate:{left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["w","ArrowUp"],down:["s","ArrowDown"],bottom:[" "]},onceKey:["up","bottom"],speedUpKey:["down"],speedUpRate:2,pause:["Enter","p"]},B={left:!1,right:!1,up:!1,down:!1,bottom:!1};let f=null;window.onkeydown=s=>{switch(document.activeElement===s.target&&s.preventDefault(),!0){case d.pause.some(t=>t===s.key):f=s.key;break;case Object.values(d.operate).flat(1).some(t=>t===s.key):f=s.key}};window.onkeyup=s=>{switch(!0){case f===s.key:f=null;default:let t;(t=O(s.key))&&(B[t]=!1)}};function O(s){if(d.pause.some(t=>t===s))return"pause";for(const[t,e]of Object.entries(d.operate))if(e.some(i=>i===s))return t}const I=s=>{let t=1e3/l.keySpeed;return d.speedUpKey.some(e=>e===s)&&(t=1e3/d.speedUpRate/l.keySpeed),t},x=function(){const s={left:"left",right:"right",down:"downOne",bottom:"downToBottom",up:"rotate"};return(t,e)=>d.onceKey.some(i=>i===e)&&B[e]?null:t[s[e]].bind(t)}(),U=s=>d.pause.some(t=>t===s);let k=0;const Y=function(s,t,e){if(f===null||t)return;if(U(f)){e.pauseGame(),f=null;return}if(s)return;let i=Date.now();const a=O(f);if(!B[a]){k=i;let r=x(e,a);r==null||r(),B[a]=!0;return}let n=I(a);if(i-k>=n){k=i-(i-k)%n;let r=x(e,a);r==null||r()}};class q{constructor(t,e,i,a){this.game=t,this.canvasWithMapCtx=e,this.brick=i,this.Player=a}takeTurns(t){this.brick=t}left(){this.brick.left(this.canvasWithMapCtx.mapBinary)}right(){this.brick.right(this.canvasWithMapCtx.mapBinary)}downOne(){this.brick.downOne(this.canvasWithMapCtx.mapBinary)&&(this.brick.isRecycle=!0)}downToBottom(){this.brick.downToBottom(this.canvasWithMapCtx.mapBinary)&&(this.brick.isRecycle=!0)}rotate(){this.brick.rotate(this.canvasWithMapCtx.mapBinary)}pauseGame(){this.game.state.pause?this.Player.playGame():this.Player.pauseGame()}}class _{constructor(t){h(this,"operation");h(this,"gameHelper");h(this,"lastTime",0);h(this,"pauseTime",0);h(this,"game");h(this,"_brick");h(this,"_nextBrick");h(this,"over",!1);h(this,"pause",!1);h(this,"_canvasWithMapCtx");this._canvasWithMapCtx=new G,this.gameHelper=M,this.game=t,this._brick=new g(this.gameHelper.getRandomLetter()),this._nextBrick=new g(this.gameHelper.getRandomLetter()),this.operation=new q(this.game,this._canvasWithMapCtx,this.brick,{playGame:this.playGame.bind(this),pauseGame:this.pauseGame.bind(this),togglePause:this.togglePause.bind(this)})}get canvasWithMapCtx(){return this._canvasWithMapCtx}get brick(){return this._brick}get nextBrick(){return this._nextBrick}render(t){if(this.userActions(),this.pause){this.cachePauseTime(t);return}this.over||(this.clearCanvas(this.canvasWithMapCtx.brickCtx),this.lastTime=t,this.draw(),this.update(t-this.pauseTime),this.checkBrickState(t-this.pauseTime))}clearCanvas(t){t.clearRect(0,0,t.canvas.width,t.canvas.height)}draw(){this.operation.brick.draw(this.canvasWithMapCtx.brickCtx)}update(t){this.operation.brick.update(t,this.canvasWithMapCtx.mapBinary)&&(this.operation.brick.isRecycle=!0)}checkBrickState(t){this.operation.brick.isRecycle&&this.replaceNextOne(t)}replaceNextOne(t){if(!this.gameHelper.record(this.canvasWithMapCtx.mapBinary,this.canvasWithMapCtx.bg,this.brick)){this.over=!0,this.game.state.setOver();return}const i=this.gameHelper.eliminate(this.canvasWithMapCtx.mapBinary,this.canvasWithMapCtx.bg,this.brick.y,Math.min(this.brick.y+this.brick.structure.length,this.canvasWithMapCtx.mapBinary.length));console.time("drawBg"),this.gameHelper.drawBg(this.canvasWithMapCtx.bgCtx,this.canvasWithMapCtx.bg,g.width,g.height),console.timeEnd("drawBg");const a=this.gameHelper.computeScore(i);this._brick=this.nextBrick,this._nextBrick=new g(this.gameHelper.getRandomLetter(),t),this.brick.correctLastTime(t),this.operation.takeTurns(this.brick),this.game.state.setNextBrick(this.nextBrick,this),this.game.state.setScore(a+this.game.state.score),this.game.state.setEliminateNum(i+this.game.state.eliminateNum)}cachePauseTime(t){this.pauseTime+=t-this.lastTime,this.lastTime=t}playGame(){this.game.state.setPause(!1),this.pause=!1}pauseGame(){this.game.state.setPause(!0),this.pause=!0}togglePause(){this.game.state.setPause(!this.game.state.pause),this.pause=!this.pause}userActions(){Y(this.pause,this.over,this.operation)}}class z{constructor(){h(this,"_nextBrick");h(this,"_over");h(this,"_pause");h(this,"_score");h(this,"_eliminateNum");h(this,"_playing");this.initState()}initState(){this._nextBrick=null,this._over=!1,this._pause=!1,this._score=0,this._eliminateNum=0,this._playing=!1}get nextBrick(){return this._nextBrick}get over(){return this._over}get pause(){return this._pause}get score(){return this._score}get eliminateNum(){return this._eliminateNum}get playing(){return this._playing}setNextBrick(t,e){this._nextBrick=t,t&&M.drawNextBrick(e.canvasWithMapCtx.nextBrickCtx,t)}setOver(){this.setPlaying(!1),this._over=!0}setPause(t){this._pause=t}setScore(t){this._score=t}setPlaying(t){this._playing=t}setEliminateNum(t){this._eliminateNum=t}}const V=P(z),X=A(new V),$=X;class et{constructor(){h(this,"renderer");h(this,"_state");h(this,"startWithEnd");h(this,"startRaf");h(this,"cancelRaf");this.renderer=new _(this),this._state=$,this.defineRaf(this.renderer)}get state(){return this._state}defineRaf(t){this.startWithEnd=D((e=performance.now())=>{t.render(e)},l.FPS),this.startRaf=this.startWithEnd[0],this.cancelRaf=this.startWithEnd[1]}startGame(){this.startRaf(),this.state.setPlaying(!0),this.state.setNextBrick(this.renderer.nextBrick,this.renderer)}cancelGame(){this.cancelRaf()}restartGame(){this.cancelRaf(),this.state.initState(),this.renderer=new _(this),this.defineRaf(this.renderer),this.startRaf(),this.state.setPlaying(!0),this.state.setNextBrick(this.renderer.nextBrick,this.renderer)}playGame(){this.renderer.playGame()}pauseGame(){this.renderer.pauseGame()}togglePause(){this.renderer.togglePause()}}export{et as default};
