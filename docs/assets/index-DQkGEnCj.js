var C=Object.defineProperty;var N=(r,e,t)=>e in r?C(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>(N(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const a={column:10,row:20,FPS:165,speed:2,keySpeed:10,score:0,get brickWidth(){return window.innerWidth/this.column},get brickHeight(){return window.innerHeight/this.row}},b={o:{color:"#FADADD",struct:["11","11"]},i:{color:"#F7E9D4",struct:["0000","1111","0000","0000"]},s:{color:"#C8E6C9",struct:["011","110","000"]},z:{color:"#B3E5FC",struct:["110","011","000"]},l:{color:"#FFCC80",struct:["001","111","000"]},j:{color:"#FFEE58",struct:["100","111","000"]},t:{color:"#CE93D8",struct:["000","111","010"]}},d={operate:{left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["w","ArrowUp"],down:["s","ArrowDown"],bottom:[" "]},onceKey:["up","bottom"],speedUpKey:["down"],pause:["Enter","p"]},T=(r,{x:e,y:t,width:s,height:i,color:n})=>{var o=8,u=5;r.fillStyle=n,r.beginPath(),r.moveTo(e+o,t),r.lineTo(e+s-o,t),r.arcTo(e+s,t,e+s,t+o,o),r.lineTo(e+s,t+i-o),r.arcTo(e+s,t+i,e+s-o,t+i,o),r.lineTo(e+o,t+i),r.arcTo(e,t+i,e,t+i-o,o),r.lineTo(e,t+o),r.arcTo(e,t,e+o,t,o),r.fill(),r.strokeStyle="#000000",r.lineWidth=u,r.beginPath(),r.moveTo(e+o,t),r.lineTo(e+s-o,t),r.arcTo(e+s,t,e+s,t+o,o),r.lineTo(e+s,t+i-o),r.arcTo(e+s,t+i,e+s-o,t+i,o),r.lineTo(e+o,t+i),r.arcTo(e,t+i,e,t+i-o,o),r.lineTo(e,t+o),r.arcTo(e,t,e+o,t,o),r.stroke(),r.closePath()},P=(r,{x:e,y:t,width:s,height:i,color:n,structure:o})=>{for(let u=0;u<o.length;u++)for(let h=0;h<o[u].length;h++)o[u][h]!="0"&&T(r,{x:(e+h)*s,y:(t+u)*i,width:s,height:i,color:n})},S=function(r,e,t=a.brickWidth,s=a.brickHeight){r.clearRect(0,0,r.canvas.width,r.canvas.height);for(let i=0;i<e.length;i++)for(let n=0;n<e[i].length;n++)e[i][n]!==void 0&&T(r,{x:n*t,y:i*s,width:t,height:s,color:e[i][n]})},R=()=>{const r=Object.keys(b);return r[Math.random()*r.length>>0]},F=r=>{const e=r.findLastIndex(t=>+t!=0);return e===-1?-r.length:-e-1};class O{constructor(e=performance.now()){l(this,"letter");l(this,"lastTime");l(this,"color");l(this,"structure");l(this,"x");l(this,"y");l(this,"width",a.brickWidth);l(this,"height",a.brickHeight);l(this,"isRecycle",!1);this.letter=R(),this.color=b[this.letter].color,this.structure=b[this.letter].struct,this.x=a.column/2-1,this.y=F(this.structure),this.lastTime=e}draw(e){P(e,this)}update(e,t){return e-this.lastTime>=1e3/a.speed?(this.lastTime=e-(e-this.lastTime)%(1e3/a.speed),this.isOverlap(t,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)):!1}left(e){this.inBorder("left")||this.isOverlap(e,this.getBinary(),this.x-1)||this.x--}right(e){this.inBorder("right")||this.isOverlap(e,this.getBinary(),this.x+1)||this.x++}downOne(e){return this.isOverlap(e,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)}downBottom(e){for(;!this.isOverlap(e,this.getBinary(),this.x,this.y+1);)this.y++;return!0}rotate(e){const t=this.structure[0].length;let s=Array.from({length:t},()=>new Array(t));for(let n=0;n<this.structure.length;n++)for(let o=0;o<this.structure[n].length;o++){let u=n,h=t-1-o;if(this.structure[n][o]==="1"&&(u+this.x>=a.column||u+this.x<0||h+this.y>=a.row))return;s[h][u]=this.structure[n][o]}s=s.map(n=>n.join(""));const i=this.getBinary(s);this.isOverlap(e,i)||(this.structure=s)}getBinary(e=this.structure,t=this.x){const s=[],i=e[0].length;for(let n=e.length-1;n>=0;n--){let o,u=a.column-t-i;u>=0?o=parseInt(e[n],2)<<u:o=parseInt(e[n],2)>>-u,s.unshift(o)}return s}isOverlap(e,t=this.getBinary(),s=this.x,i=this.y){if(s-this.x!==0){const n=s-this.x;n>0?t=t.map(o=>o>>n):t=t.map(o=>o<<-n)}for(let n=t.length-1;n>=0;n--)if(!(i+n<0)&&t[n]&(e[i+n]??2**a.column-1))return!0;return!1}inBorder(e){let t=this.getBinary(),s=e=="left"?2**(a.column-1):1;for(let i=t.length-1;i>=0;i--)if(t[i]&s)return!0;return!1}}const g={left:!1,right:!1,up:!1,down:!1,bottom:!1};let c=null;window.onkeydown=r=>{switch(!0){case d.pause.some(e=>e===r.key):{c=r.key;break}case Object.values(d.operate).flat(1).some(e=>e===r.key):c=r.key}};window.onkeyup=r=>{switch(!0){case c===r.key:c=null;default:let e;(e=v(r.key))&&(g[e]=!1)}};function v(r){if(d.pause.some(e=>e===r))return"pause";for(const[e,t]of Object.entries(d.operate))if(t.some(s=>s===r))return e}const j=r=>{let e=1e3/a.keySpeed;return d.speedUpKey.some(t=>t===r)&&(e=500/a.keySpeed),e},y=function(){const r={left:"left",right:"right",down:"downOne",bottom:"downBottom",up:"rotate",pause:"pauseGame"};return(e,t)=>t==="pause"?e.pauseGame.bind(e):d.onceKey.some(s=>s===t)&&g[t]?null:e[r[t]].bind(e)}();let p=0;const L=r=>d.pause.some(e=>e===r),D=function(r,e){if(c===null)return;if(console.log(c),L(c)){let n=y(e,"pause");n==null||n(),c=null;return}if(r)return;let t=Date.now();const s=v(c);if(!g[s]){p=t;let n=y(e,s);n==null||n(),g[s]=!0;return}let i=j(s);if(t-p>=i){p=t-(t-p)%i;let n=y(e,s);n&&n()}};class E{constructor(e,t,s){this.game=e,this.mapBinary=t,this.brick=s}left(){this.brick.left(this.mapBinary)}right(){this.brick.right(this.mapBinary)}downOne(){this.brick.downOne(this.mapBinary)&&(this.brick.isRecycle=!0)}downBottom(){this.brick.downBottom(this.mapBinary)&&(this.brick.isRecycle=!0)}rotate(){this.brick.rotate(this.mapBinary)}pauseGame(){this.game.pause=!this.game.pause}}const G=(r,e,t)=>{if(W(t))return!1;const s=t.getBinary();for(let i=s.length-1;i>=0;i--)if(s[i]!==0){r[t.y+i]|=s[i];for(let n=a.column-1,o=s[i];o!==0;n--,o>>=1)o&1&&(e[t.y+i][n]=t.color)}return!0},K=(r,e)=>{let t=0;for(let s=a.row-1;s>=0;s--)r[s]===2**a.column-1&&(t++,r.splice(s,1),r.unshift(0),e.splice(s,1),e.unshift(Array.from({length:a.column})),s++);return t},W=r=>{const e=r.structure.length;for(let t=0;t<e;t++)if(r.y+t<0)return!0;return!1},B=r=>document.querySelector(r),f=B(".canvas.brick"),m=B(".canvas.bg");f.height=m.height=window.innerHeight;f.width=m.width=window.innerWidth;class k{constructor(){l(this,"mapBinary",new Array(a.row).fill(0));l(this,"bg",Array.from({length:a.row},()=>Array.from({length:a.column})));l(this,"ctx",f.getContext("2d"));l(this,"bgCtx",m.getContext("2d"));l(this,"operate",new E(this,this.mapBinary,new O));l(this,"lastTime",0);l(this,"pauseTime",0);l(this,"isOver",!1);l(this,"pause",!1)}render(e){if(this.userAction(),this.pause){this.cachePauseTime(e);return}this.ctx.clearRect(0,0,f.width,f.height),this.lastTime=e,this.draw(),this.update(e-this.pauseTime),this.canNextOne(e-this.pauseTime)}reSetCanvas(){this.ctx.clearRect(0,0,f.width,f.height),this.bgCtx.clearRect(0,0,m.width,m.height)}draw(){this.operate.brick.draw(this.ctx)}update(e){this.operate.brick.update(e,this.mapBinary)&&(this.operate.brick.isRecycle=!0)}canNextOne(e){this.operate.brick.isRecycle&&this.newNextOne(e)}newNextOne(e){if(!G(this.mapBinary,this.bg,this.operate.brick)){this.isOver=!0;return}K(this.mapBinary,this.bg),S(this.bgCtx,this.bg),this.operate.brick=new O(e)}cachePauseTime(e){this.pauseTime+=e-this.lastTime,this.lastTime=e}userAction(){D(this.pause,this.operate)}}let w=new k;const H=r=>{r.isOver&&(alert("Game Over"),I())},I=()=>{w.reSetCanvas(),w=new k},A=(r=performance.now())=>{requestAnimationFrame(A),w.render(r),H(w)};A();
