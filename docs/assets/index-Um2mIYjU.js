var N=Object.defineProperty;var G=(i,t,e)=>t in i?N(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var h=(i,t,e)=>G(i,typeof t!="symbol"?t+"":t,e);import{gameParam as l}from"./gameConfig-n0tYIkE6.js";import A from"./CanvasWithMapCtx-BI5t-u4B.js";import{s as H}from"./index-CUDUUHN-.js";const P={o:{color:"#FADADD",struct:["11","11"]},i:{color:"#F7E9D4",struct:["0000","1111","0000","0000"]},s:{color:"#C8E6C9",struct:["011","110","000"]},z:{color:"#B3E5FC",struct:["110","011","000"]},l:{color:"#FFCC80",struct:["001","111","000"]},j:{color:"#FFEE58",struct:["100","111","000"]},t:{color:"#CE93D8",struct:["000","111","010"]},".":{color:"green",struct:["1"]}},O=2**l.column-1;class _{constructor(t,e){this.x=t,this.y=e}withOffset(t,e){return new _(this.x+t,this.y+e)}}const y=class y{constructor(t){h(this,"_letter");h(this,"_struct");this._letter=t,this._struct=this.getStructureVal()}get color(){return P[this._letter].color}get width(){return y.width}get height(){return y.height}get letter(){return this._letter}get struct(){return this._struct}setStruct(t){this._struct=t}setLetter(t){this._letter=t}getStructureVal(){return P[this._letter].struct.map(t=>parseInt(t,2))}};h(y,"height",l.brickHeight),h(y,"width",l.brickWidth);let w=y;class E extends w{constructor(e,s){super(e);h(this,"_point");h(this,"_landingPoint");h(this,"_isRecycle",!1);h(this,"mapBinary");this._point=new _(this.getInitX(),this.getInitY()),this.mapBinary=s,this.computeLandingPoint()}get landingPoint(){return this._landingPoint}get isRecycle(){return this._isRecycle}get point(){return this._point}get structure(){return this.struct}setStructure(e){this.setStruct(e),this.computeLandingPoint()}setPoint(e){let s=this._point.x;this._point=e,s!==e.x&&this.computeLandingPoint()}setLandingPoint(e){this._landingPoint=e}setRecycle(){this._isRecycle=!0}getStructWithOffset(e=this.structure,s=this._point.x){const r=l.column-s-e.length;return e.map(n=>r>=0?n<<r:n>>-r)}getInitX(){return Math.floor(l.column/2)-Math.floor(this.structure.length/2)}getInitY(){const e=this.structure.findLastIndex(s=>s!==0);return e===-1?-this.structure.length:-e-1}computeLandingPoint(){let e=this._point.withOffset(0,0),s=1;for(;!this.isOverlap(e.withOffset(0,s));)s++;this.setLandingPoint(e.withOffset(0,s-1))}isOverlap({x:e,y:s}=this._point,r=this.getStructWithOffset(),n=this.mapBinary){if(e!==this._point.x){const o=e-this.point.x;o>0?r=r.map(a=>a>>o):r=r.map(a=>a<<-o)}return r.some((o,a)=>s+a<0?!1:(o&(n[s+a]??O))!==0)}}class v extends E{constructor(e,s,r=performance.now()){super(e,s);h(this,"lastTime");this.lastTime=r}update(e){if(e-this.lastTime>=1e3/l.speed){this.lastTime=e-(e-this.lastTime)%(1e3/l.speed);const s=this.point.withOffset(0,1),r=!this.isOverlap(s);return r&&this.setPoint(s),!r}return!1}left(){this.move(-1,0)}right(){this.move(1,0)}downOne(){return!this.move(0,1)}downToBottom(){for(;this.move(0,1););return!0}rotate(){const e=this.structure.length,s=new Array(e).fill(0);for(let r=0;r<e;r++)for(let n=0;n<e;n++)if(this.structure[r]&1<<e-1-n){const o=r,a=e-1-n;if(this.isOutOfBounds(o,a))return;s[a]+=1<<e-1-o}this.isOverlap(this.point,this.getStructWithOffset(s))||this.setStructure(s)}isOutOfBounds(e,s){return e+this.point.x>=l.column||e+this.point.x<0||s+this.point.y>=l.row}isAtBorder(e){const s=e?1:(O+1)/2;return this.getStructWithOffset().some(n=>n&s)}move(e,s){const r=this.point.withOffset(e,s);return(e===0||!this.isAtBorder(e>0))&&!this.isOverlap(r)?(this.setPoint(r),!0):!1}}const j=(i,{point:t,width:e,height:s,color:r})=>{const{x:n,y:o}=t,a=s/10*l.devicePixelRatio,u=s/25*l.devicePixelRatio;i.fillStyle=r,i.beginPath(),i.moveTo(n+a,o),i.lineTo(n+e-a,o),i.arcTo(n+e,o,n+e,o+a,a),i.lineTo(n+e,o+s-a),i.arcTo(n+e,o+s,n+e-a,o+s,a),i.lineTo(n+a,o+s),i.arcTo(n,o+s,n,o+s-a,a),i.lineTo(n,o+a),i.arcTo(n,o,n+a,o,a),i.fill();const c=n+u/2,p=o+u/2,d=e-u,g=s-u;i.strokeStyle="#000000",i.lineWidth=u,i.beginPath(),i.moveTo(c+a,p),i.lineTo(c+d-a,p),i.arcTo(c+d,p,c+d,p+a,a),i.lineTo(c+d,p+g-a),i.arcTo(c+d,p+g,c+d-a,p+g,a),i.lineTo(c+a,p+g),i.arcTo(c,p+g,c,p+g-a,a),i.lineTo(c,p+a),i.arcTo(c,p,c+a,p,a),i.stroke(),i.closePath()},k=document.createElement("canvas"),D=k.getContext("2d");k.height=l.brickHeight*20;k.width=l.brickWidth;let T=0;const B={},R=(i,{point:t,width:e,height:s,color:r},n=1)=>{if(r in B){i.globalAlpha=n,i.drawImage(k,0,s*B[r],e,s,t.x,t.y,e,s),i.globalAlpha=1;return}j(D,{point:{x:0,y:T*s},width:e,height:s,color:r}),B[r]=T++,i.drawImage(k,0,s*B[r],e,s,t.x,t.y,e,s)},F=(i,{width:t,height:e,color:s,struct:r},n,o)=>{const a=r.length;for(let u=0;u<a;u++)for(let c=0;c<a;c++)r[u]&1<<a-1-c&&R(i,{point:{x:(o.x+c)*t,y:(o.y+u)*e},width:t,height:e,color:s},n)},I=(i,t)=>{let e;function s(...n){const o=u=>{i.apply(this,[u,...n])},a=u=>{e=requestAnimationFrame(a),o(u)};r(),a(0)}function r(){cancelAnimationFrame(e)}return[s,r]};function S(i){let t;const e=new Proxy(i,{construct(s,r){return t||(t=Reflect.construct(s,r)),t}});return i.prototype.constructor=e,e}class K{constructor(){h(this,"eliminateTarget",2**l.column-1)}getRandomLetter(){const t=Object.keys(P);return t[Math.random()*t.length>>0]}record(t,e,s){if(this.isGameOver(s))return!1;const r=s.getStructWithOffset();for(let n=r.length-1;n>=0;n--)if(r[n]!==0){t[s.point.y+n]|=r[n];for(let o=l.column-1,a=r[n];a!==0;o--,a>>=1)a&1&&(e[s.point.y+n][o]=s.color)}return!0}eliminate(t,e,s,r){let n=0;for(;s<r;){if(t[s]===this.eliminateTarget){t.splice(s,1),t.unshift(0),e.splice(s,1),e.unshift(new Array(e[0].length)),n++;continue}s++}return n}isGameOver(t){const e=t.structure.length;for(let s=0;s<e;s++)if(t.point.y+s<0)return!0;return!1}drawBg(t,e,s,r){t.clearRect(0,0,t.canvas.width,t.canvas.height);for(let n=0;n<e.length;n++)for(let o=0;o<e[n].length;o++)e[n][o]!==void 0&&R(t,{point:{x:o*s,y:n*r},width:s,height:r,color:e[n][o]})}drawBrick(t,e,s,r){F(t,e,r,s)}drawNextBrick(t,e){t.clearRect(0,0,t.canvas.width,t.canvas.height),this.drawBrick(t,e,{x:0,y:0},1)}computeScore(t){switch(t){case 0:return 20;case 1:return 120;case 2:return 320;case 3:return 720;case 4:return 1520;default:return 20}}}const U=S(K),M=new U,f={operate:{left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["w","ArrowUp"],down:["s","ArrowDown"],bottom:[" "]},onceKey:["up","bottom"],speedUpKey:["down"],speedUpRate:2,pause:["Enter","p"]},x={left:!1,right:!1,up:!1,down:!1,bottom:!1};let m=null;window.onkeydown=i=>{switch(document.activeElement===i.target&&i.preventDefault(),!0){case f.pause.some(t=>t===i.key):m=i.key;break;case Object.values(f.operate).flat(1).some(t=>t===i.key):m=i.key}};window.onkeyup=i=>{switch(!0){case m===i.key:m=null;default:let t;(t=L(i.key))&&(x[t]=!1)}};function L(i){if(f.pause.some(t=>t===i))return"pause";for(const[t,e]of Object.entries(f.operate))if(e.some(s=>s===i))return t}const X=i=>{let t=1e3/l.keySpeed;return f.speedUpKey.some(e=>e===i)&&(t=1e3/f.speedUpRate/l.keySpeed),t},C=function(){const i={left:"left",right:"right",down:"downOne",bottom:"downToBottom",up:"rotate"};return(t,e)=>f.onceKey.some(s=>s===e)&&x[e]?null:t[i[e]].bind(t)}(),Y=i=>f.pause.some(t=>t===i);let b=0;const V=function(i,t,e){if(m===null||t)return;if(Y(m)){e.pauseGame(),m=null;return}if(i)return;let s=Date.now();const r=L(m);if(!x[r]){b=s;let o=C(e,r);o==null||o(),x[r]=!0;return}let n=X(r);if(s-b>=n){b=s-(s-b)%n;let o=C(e,r);o==null||o()}};class q{constructor(t,e,s,r){this.game=t,this.canvasWithMapCtx=e,this.brick=s,this.Player=r}takeTurns(t){this.brick=t}left(){this.brick.left(this.canvasWithMapCtx.mapBinary)}right(){this.brick.right(this.canvasWithMapCtx.mapBinary)}downOne(){this.brick.downOne(this.canvasWithMapCtx.mapBinary)&&this.brick.setRecycle()}downToBottom(){this.brick.downToBottom(this.canvasWithMapCtx.mapBinary)&&this.brick.setRecycle()}rotate(){this.brick.rotate(this.canvasWithMapCtx.mapBinary)}pauseGame(){this.game.state.pause?this.Player.playGame():this.Player.pauseGame()}}class W{constructor(t){h(this,"operation");h(this,"gameHelper");h(this,"lastTime",0);h(this,"pauseTime",0);h(this,"game");h(this,"over",!1);h(this,"pause",!1);h(this,"canvasWithMapCtx");h(this,"brick");h(this,"nextBrickLetter");this.gameHelper=M,this.game=t,this.canvasWithMapCtx=new A,this.brick=new v(this.gameHelper.getRandomLetter(),this.canvasWithMapCtx.mapBinary),this.nextBrickLetter=this.gameHelper.getRandomLetter(),this.operation=new q(this.game,this.canvasWithMapCtx,this.brick,{playGame:this.playGame.bind(this),pauseGame:this.pauseGame.bind(this),togglePause:this.togglePause.bind(this)})}render(t){if(this.userActions(),this.pause){this.cachePauseTime(t);return}this.over||(this.clearCanvas(this.canvasWithMapCtx.brickCtx),this.lastTime=t,this.draw(),this.update(t-this.pauseTime),this.checkBrickState(t-this.pauseTime))}clearCanvas(t){t.clearRect(0,0,t.canvas.width,t.canvas.height)}draw(){this.draw=this.drawWithLandingPoint,this.draw()}drawWithoutLandingPoint(){this.gameHelper.drawBrick(this.canvasWithMapCtx.brickCtx,this.brick,this.brick.point,1)}drawWithLandingPoint(){this.drawWithoutLandingPoint(),this.gameHelper.drawBrick(this.canvasWithMapCtx.brickCtx,this.brick,this.brick.landingPoint,.3)}update(t){this.operation.brick.update(t,this.canvasWithMapCtx.mapBinary)&&this.operation.brick.setRecycle()}checkBrickState(t){this.operation.brick.isRecycle&&this.replaceNextOne(t)}replaceNextOne(t){if(!this.gameHelper.record(this.canvasWithMapCtx.mapBinary,this.canvasWithMapCtx.bg,this.brick)){this.over=!0,this.game.state.setOver();return}const s=this.gameHelper.eliminate(this.canvasWithMapCtx.mapBinary,this.canvasWithMapCtx.bg,this.brick.point.y,Math.min(this.brick.point.y+this.brick.structure.length,this.canvasWithMapCtx.mapBinary.length));console.time("drawBg"),this.gameHelper.drawBg(this.canvasWithMapCtx.bgCtx,this.canvasWithMapCtx.bg,v.width,v.height),console.timeEnd("drawBg");const r=this.gameHelper.computeScore(s);this.brick=new v(this.nextBrickLetter,this.canvasWithMapCtx.mapBinary,t),this.nextBrickLetter=this.gameHelper.getRandomLetter(),this.operation.takeTurns(this.brick),this.game.state.setNextBrick(new w(this.nextBrickLetter),this),this.game.state.setScore(r+this.game.state.score),this.game.state.setEliminateNum(s+this.game.state.eliminateNum)}cachePauseTime(t){this.pauseTime+=t-this.lastTime,this.lastTime=t}playGame(){this.game.state.setPause(!1),this.pause=!1}pauseGame(){this.game.state.setPause(!0),this.pause=!0}togglePause(){this.game.state.setPause(!this.game.state.pause),this.pause=!this.pause}userActions(){V(this.pause,this.over,this.operation)}}class z{constructor(){h(this,"_nextBrick");h(this,"_over");h(this,"_pause");h(this,"_score");h(this,"_eliminateNum");h(this,"_playing");this.initState()}initState(){this._nextBrick=null,this._over=!1,this._pause=!1,this._score=0,this._eliminateNum=0,this._playing=!1}get nextBrick(){return this._nextBrick}get over(){return this._over}get pause(){return this._pause}get score(){return this._score}get eliminateNum(){return this._eliminateNum}get playing(){return this._playing}setNextBrick(t,e){this._nextBrick=t,t&&M.drawNextBrick(e.canvasWithMapCtx.nextBrickCtx,t)}setOver(){this.setPlaying(!1),this._over=!0}setPause(t){this._pause=t}setScore(t){this._score=t}setPlaying(t){this._playing=t}setEliminateNum(t){this._eliminateNum=t}}const J=S(z),Q=H(new J);class st{constructor(){h(this,"renderer");h(this,"startWithEnd");h(this,"startRaf");h(this,"cancelRaf");h(this,"state");this.renderer=new W(this),this.state=Q,this.defineRaf(this.renderer)}defineRaf(t){this.startWithEnd=I((e=performance.now())=>{t.render(e)}),this.startRaf=this.startWithEnd[0],this.cancelRaf=this.startWithEnd[1]}startGame(){this.startRaf(),this.state.setPlaying(!0),this.state.setNextBrick(new w(this.renderer.nextBrickLetter),this.renderer)}cancelGame(){this.cancelRaf()}restartGame(){this.cancelRaf(),this.state.initState(),this.renderer=new W(this),this.defineRaf(this.renderer),this.startRaf(),this.state.setPlaying(!0),this.state.setNextBrick(new w(this.renderer.nextBrickLetter),this.renderer)}playGame(){this.renderer.playGame()}pauseGame(){this.renderer.pauseGame()}togglePause(){this.renderer.togglePause()}}export{st as default};
