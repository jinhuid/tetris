var M=Object.defineProperty;var N=(s,t,e)=>t in s?M(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var o=(s,t,e)=>(N(s,typeof t!="symbol"?t+"":t,e),e);import{gameParam as l}from"./gameConfig-DWGiOOs9.js";import S from"./CanvasWithMapCtx-DIQaPKYH.js";import{s as G}from"./index-CsbXuoHl.js";const A=(s,{x:t,y:e,width:i,height:a,color:n})=>{const r=a/10*l.devicePixelRatio,c=a/25*l.devicePixelRatio;s.fillStyle=n,s.beginPath(),s.moveTo(t+r,e),s.lineTo(t+i-r,e),s.arcTo(t+i,e,t+i,e+r,r),s.lineTo(t+i,e+a-r),s.arcTo(t+i,e+a,t+i-r,e+a,r),s.lineTo(t+r,e+a),s.arcTo(t,e+a,t,e+a-r,r),s.lineTo(t,e+r),s.arcTo(t,e,t+r,e,r),s.fill();const h=t+c/2,u=e+c/2,p=i-c,m=a-c;s.strokeStyle="#000000",s.lineWidth=c,s.beginPath(),s.moveTo(h+r,u),s.lineTo(h+p-r,u),s.arcTo(h+p,u,h+p,u+r,r),s.lineTo(h+p,u+m-r),s.arcTo(h+p,u+m,h+p-r,u+m,r),s.lineTo(h+r,u+m),s.arcTo(h,u+m,h,u+m-r,r),s.lineTo(h,u+r),s.arcTo(h,u,h+r,u,r),s.stroke(),s.closePath()},k=document.createElement("canvas"),E=k.getContext("2d");k.height=l.brickHeight*20;k.width=l.brickWidth;let _=0;const v={},x=(s,{x:t,y:e,width:i,height:a,color:n})=>{if(n in v){s.drawImage(k,0,a*v[n],i,a,t,e,i,a);return}A(E,{x:0,y:_*a,width:i,height:a,color:n}),v[n]=_++,s.drawImage(k,0,a*v[n],i,a,t,e,i,a)},R=(s,{x:t,y:e,width:i,height:a,color:n,structure:r})=>{for(let c=0;c<r.length;c++)for(let h=0;h<r[c].length;h++)r[c][h]!="0"&&x(s,{x:(t+h)*i,y:(e+c)*a,width:i,height:a,color:n})},T={o:{color:"#FADADD",struct:["11","11"]},i:{color:"#F7E9D4",struct:["0000","1111","0000","0000"]},s:{color:"#C8E6C9",struct:["011","110","000"]},z:{color:"#B3E5FC",struct:["110","011","000"]},l:{color:"#FFCC80",struct:["001","111","000"]},j:{color:"#FFEE58",struct:["100","111","000"]},t:{color:"#CE93D8",struct:["000","111","010"]},".":{color:"green",struct:["1"]}},H=s=>{const t=s.findLastIndex(e=>+e!=0);return t===-1?-s.length:-t-1},y=class y{constructor(t,e=performance.now()){o(this,"color");o(this,"width");o(this,"height");o(this,"structure");o(this,"x");o(this,"y");o(this,"isRecycle",!1);this.letter=t,this.lastTime=e,this.color=T[this.letter].color,this.width=y.width,this.height=y.height,this.structure=T[this.letter].struct,this.x=l.column/2-1,this.y=H(this.structure)}draw(t){R(t,this)}update(t,e){return t-this.lastTime>=1e3/l.speed?(this.lastTime=t-(t-this.lastTime)%(1e3/l.speed),this.isOverlap(e,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)):!1}left(t){this.isAtBorder("left")||this.isOverlap(t,this.getBinary(),this.x-1)||this.x--}right(t){this.isAtBorder("right")||this.isOverlap(t,this.getBinary(),this.x+1)||this.x++}downOne(t){return this.isOverlap(t,this.getBinary(),this.x,this.y+1)?!0:(this.y++,!1)}downToBottom(t){for(;!this.isOverlap(t,this.getBinary(),this.x,this.y+1);)this.y++;return!0}rotate(t){const e=this.structure[0].length;let i=Array.from({length:e},()=>new Array(e));for(let n=0;n<this.structure.length;n++)for(let r=0;r<this.structure[n].length;r++){let c=n,h=e-1-r;if(this.structure[n][r]==="1"&&(c+this.x>=l.column||c+this.x<0||h+this.y>=l.row))return;i[h][c]=this.structure[n][r]}i=i.map(n=>n.join(""));const a=this.getBinary(i);this.isOverlap(t,a)||(this.structure=i)}getBinary(t=this.structure,e=this.x){const i=[],a=t[0].length,n=l.column-e-a;for(let r=a-1;r>=0;r--){let c;n>=0?c=parseInt(t[r],2)<<n:c=parseInt(t[r],2)>>-n,i.unshift(c)}return i}correctLastTime(t){this.lastTime=t}isOverlap(t,e=this.getBinary(),i=this.x,a=this.y){if(i-this.x!==0){const n=i-this.x;n>0?e=e.map(r=>r>>n):e=e.map(r=>r<<-n)}for(let n=e.length-1;n>=0;n--)if(!(a+n<0)&&e[n]&(t[a+n]??2**l.column-1))return!0;return!1}isAtBorder(t){const e=this.getBinary(),i={left:2**(l.column-1),right:1};for(let a=e.length-1;a>=0;a--)if(e[a]&i[t])return!0;return!1}};o(y,"height",l.brickHeight),o(y,"width",l.brickWidth);let g=y;const j=(s,t)=>{if(t&&(!Number.isInteger(t)||t<=0))throw new TypeError("fps 应该是一个正整数");let e;function i(...n){const r=(()=>{if(t){const h=1e3/t;let u=0;return p=>{const m=p-u;m>=h&&(s.apply(this,[p,...n]),u=p-m%h)}}return h=>{s.apply(this,[h,...n])}})(),c=h=>{e=requestAnimationFrame(c),r(h)};a(),c(0)}function a(){cancelAnimationFrame(e)}return[i,a]};function W(s){let t;const e=new Proxy(s,{construct(i,a){return t||(t=Reflect.construct(i,a)),t}});return s.prototype.constructor=e,e}class F{constructor(){o(this,"eliminateTarget",2**l.column-1)}getRandomLetter(){const t=Object.keys(T);return t[Math.random()*t.length>>0]}record(t,e,i){if(this.isGameOver(i))return!1;const a=i.getBinary();for(let n=a.length-1;n>=0;n--)if(a[n]!==0){t[i.y+n]|=a[n];for(let r=l.column-1,c=a[n];c!==0;r--,c>>=1)c&1&&(e[i.y+n][r]=i.color)}return!0}eliminate(t,e,i,a){let n=0;for(;i<a;){if(t[i]===this.eliminateTarget){t.splice(i,1),t.unshift(0),e.splice(i,1),e.unshift(new Array(e[0].length)),n++;continue}i++}return n}isGameOver(t){const e=t.structure.length;for(let i=0;i<e;i++)if(t.y+i<0)return!0;return!1}drawBg(t,e,i,a){t.clearRect(0,0,t.canvas.width,t.canvas.height);for(let n=0;n<e.length;n++)for(let r=0;r<e[n].length;r++)e[n][r]!==void 0&&x(t,{x:r*i,y:n*a,width:i,height:a,color:e[n][r]})}drawNextBrick(t,e){t.clearRect(0,0,t.canvas.width,t.canvas.height),R(t,{...e,x:0,y:0})}computeScore(t){switch(t){case 0:return 20;case 1:return 120;case 2:return 320;case 3:return 720;case 4:return 1520;default:return 20}}}const D=W(F),P=new D,d={operate:{left:["a","ArrowLeft"],right:["d","ArrowRight"],up:["w","ArrowUp"],down:["s","ArrowDown"],bottom:[" "]},onceKey:["up","bottom"],speedUpKey:["down"],speedUpRate:2,pause:["Enter","p"]},B={left:!1,right:!1,up:!1,down:!1,bottom:!1};let f=null;window.onkeydown=s=>{switch(!0){case d.pause.some(t=>t===s.key):f=s.key;break;case Object.values(d.operate).flat(1).some(t=>t===s.key):f=s.key}};window.onkeyup=s=>{switch(!0){case f===s.key:f=null;default:let t;(t=O(s.key))&&(B[t]=!1)}};function O(s){if(d.pause.some(t=>t===s))return"pause";for(const[t,e]of Object.entries(d.operate))if(e.some(i=>i===s))return t}const L=s=>{let t=1e3/l.keySpeed;return d.speedUpKey.some(e=>e===s)&&(t=1e3/d.speedUpRate/l.keySpeed),t},b=function(){const s={left:"left",right:"right",down:"downOne",bottom:"downToBottom",up:"rotate"};return(t,e)=>d.onceKey.some(i=>i===e)&&B[e]?null:t[s[e]].bind(t)}(),I=s=>d.pause.some(t=>t===s);let w=0;const K=function(s,t,e){if(f===null||t)return;if(I(f)){e.pauseGame(),f=null;return}if(s)return;let i=Date.now();const a=O(f);if(!B[a]){w=i;let r=b(e,a);r==null||r(),B[a]=!0;return}let n=L(a);if(i-w>=n){w=i-(i-w)%n;let r=b(e,a);r==null||r()}};class U{constructor(t,e,i,a){this.game=t,this.canvasWithMapCtx=e,this.brick=i,this.Player=a}takeTurns(t){this.brick=t}left(){this.brick.left(this.canvasWithMapCtx.mapBinary)}right(){this.brick.right(this.canvasWithMapCtx.mapBinary)}downOne(){this.brick.downOne(this.canvasWithMapCtx.mapBinary)&&(this.brick.isRecycle=!0)}downToBottom(){this.brick.downToBottom(this.canvasWithMapCtx.mapBinary)&&(this.brick.isRecycle=!0)}rotate(){this.brick.rotate(this.canvasWithMapCtx.mapBinary)}pauseGame(){this.game.state.pause?this.Player.playGame():this.Player.pauseGame()}}class C{constructor(t){o(this,"operation");o(this,"gameHelper");o(this,"lastTime",0);o(this,"pauseTime",0);o(this,"game");o(this,"_brick");o(this,"_nextBrick");o(this,"over",!1);o(this,"pause",!1);o(this,"_canvasWithMapCtx");this._canvasWithMapCtx=new S,this.gameHelper=P,this.game=t,this._brick=new g(this.gameHelper.getRandomLetter()),this._nextBrick=new g(this.gameHelper.getRandomLetter()),this.operation=new U(this.game,this._canvasWithMapCtx,this.brick,{playGame:this.playGame.bind(this),pauseGame:this.pauseGame.bind(this),togglePause:this.togglePause.bind(this)})}get canvasWithMapCtx(){return this._canvasWithMapCtx}get brick(){return this._brick}get nextBrick(){return this._nextBrick}render(t){if(this.userActions(),this.pause){this.cachePauseTime(t);return}this.over||(this.clearCanvas(this._canvasWithMapCtx.brickCtx),this.lastTime=t,this.draw(),this.update(t-this.pauseTime),this.checkBrickState(t-this.pauseTime))}clearCanvas(t){t.clearRect(0,0,t.canvas.width,t.canvas.height)}draw(){this.operation.brick.draw(this._canvasWithMapCtx.brickCtx)}update(t){this.operation.brick.update(t,this._canvasWithMapCtx.mapBinary)&&(this.operation.brick.isRecycle=!0)}checkBrickState(t){this.operation.brick.isRecycle&&this.replaceNextOne(t)}replaceNextOne(t){if(!this.gameHelper.record(this._canvasWithMapCtx.mapBinary,this._canvasWithMapCtx.bg,this.brick)){this.over=!0,this.game.state.setOver();return}const i=this.gameHelper.eliminate(this._canvasWithMapCtx.mapBinary,this._canvasWithMapCtx.bg,this.brick.y,Math.min(this.brick.y+this.brick.structure.length,this._canvasWithMapCtx.mapBinary.length));console.time("drawBg"),this.gameHelper.drawBg(this._canvasWithMapCtx.bgCtx,this._canvasWithMapCtx.bg,g.width,g.height),console.timeEnd("drawBg");const a=this.gameHelper.computeScore(i);this._brick=this.nextBrick,this._nextBrick=new g(this.gameHelper.getRandomLetter(),t),this.brick.correctLastTime(t),this.operation.takeTurns(this.brick),this.game.state.setNextBrick(this.nextBrick,this),this.game.state.setScore(a+this.game.state.score),this.game.state.setEliminateNum(i+this.game.state.eliminateNum)}cachePauseTime(t){this.pauseTime+=t-this.lastTime,this.lastTime=t}playGame(){this.game.state.setPause(!1),this.pause=!1}pauseGame(){this.game.state.setPause(!0),this.pause=!0}togglePause(){this.game.state.setPause(!this.game.state.pause),this.pause=!this.pause}userActions(){K(this.pause,this.over,this.operation)}}class Y{constructor(){o(this,"_nextBrick");o(this,"_over");o(this,"_pause");o(this,"_score");o(this,"_eliminateNum");o(this,"_playing");this.initState()}initState(){this._nextBrick=null,this._over=!1,this._pause=!1,this._score=0,this._eliminateNum=0,this._playing=!1}get nextBrick(){return this._nextBrick}get over(){return this._over}get pause(){return this._pause}get score(){return this._score}get eliminateNum(){return this._eliminateNum}get playing(){return this._playing}setNextBrick(t,e){this._nextBrick=t,t&&P.drawNextBrick(e.canvasWithMapCtx.nextBrickCtx,t)}setOver(){this.setPlaying(!1),this._over=!0}setPause(t){this._pause=t}setScore(t){this._score=t}setPlaying(t){this._playing=t}setEliminateNum(t){this._eliminateNum=t}}const q=W(Y),z=G(new q),V=z;class Z{constructor(){o(this,"renderer");o(this,"_state");o(this,"startWithEnd");o(this,"startRaf");o(this,"cancelRaf");this.renderer=new C(this),this._state=V,this.defineRaf(this.renderer)}get state(){return this._state}defineRaf(t){this.startWithEnd=j((e=performance.now())=>{t.render(e)},l.FPS),this.startRaf=this.startWithEnd[0],this.cancelRaf=this.startWithEnd[1]}startGame(){this.startRaf(),this.state.setPlaying(!0),this.state.setNextBrick(this.renderer.nextBrick,this.renderer)}cancelGame(){this.cancelRaf()}restartGame(){this.cancelRaf(),this.state.initState(),this.renderer=new C(this),this.defineRaf(this.renderer),this.startRaf(),this.state.setPlaying(!0),this.state.setNextBrick(this.renderer.nextBrick,this.renderer)}playGame(){this.renderer.playGame()}pauseGame(){this.renderer.pauseGame()}togglePause(){this.renderer.togglePause()}}export{Z as default};
